<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Free Market Ragnarok</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="_css/style.css">
</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-light bg-warning fixed-top shadow-sm">
    <div class="container align-items-center">
      <a class="navbar-brand fw-bold" href="#">
        <i class="fas fa-store"></i> Free Market RO
      </a>
      <div class="ms-auto" style="max-width:400px;">
        <form class="d-flex" id="form-busca">
          <input class="form-control me-2" type="search" placeholder="Buscar itens..." aria-label="Buscar" id="input-busca">
          <button class="btn btn-outline-dark" type="submit"><i class="fas fa-search"></i></button>
        </form>
      </div>
    </div>
  </nav>

  <!-- Remova a barra horizontal de categorias -->
  <!-- ESPAÇO PARA NAVBAR FIXA -->
  <div style="height:70px"></div>

  <div class="container py-4">
    <div class="row">
      <div class="col-lg-3 mb-4">
        <!-- Top Vendedores -->
        <div class="card mt-3" id="top-vendedores-card">
          <div class="card-header bg-light fw-bold">Top Vendedores</div>
          <ul class="list-group list-group-flush" id="top-vendedores-list">
            <!-- Ranking será carregado via JS -->
          </ul>
        </div>
        <!-- Patrocinador na sidebar -->
        <div class="card mt-3" id="patrocinador-sidebar">
          <div class="card-body text-center">
            <a href="https://patrocinador.com" target="_blank">
              <img src="_img/patrocinador1.png" alt="Patrocinador" style="max-width:100%;">
            </a>
            <div class="mt-2">Patrocínio: <strong>Patrocinador 1</strong></div>
          </div>
        </div>
      </div>
      <div class="col-lg-9">
        <!-- Categorias como abas estilo pasta de documento -->
        <ul id="categorias-tabs" class="nav nav-tabs mb-3 border-0" style="gap:0.5rem;">
          <!-- Abas serão carregadas via JS -->
        </ul>
        <div class="card mb-4 border-0 shadow-sm">
          <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-store"></i> Itens à Venda</h4>
          </div>
          <div class="card-body">
            <div class="row row-cols-1 row-cols-md-3 row-cols-lg-3 row-cols-xl-3 g-3" id="itens-container">
              <!-- Itens serão carregados aqui via JavaScript -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Espaço extra para rodapé fixo -->
  <div style="height:80px"></div>
  <!-- RODAPÉ -->
  <footer class="bg-warning text-dark text-center py-3 mt-4 fixed-bottom" style="width:100%;z-index:1030;">
    Free Market Ragnarok &copy; 2024 - Inspirado no Mercado Livre<br>
    <span>Patrocínio: <a href="https://patrocinador.com" target="_blank">Patrocinador 1</a></span>
  </footer>

  <script>
    // FUNÇÃO PARA FORMATAR PREÇO (1.000 = 1k, 1.000.000 = 1kk)
    function formatarPreco(preco) {
      if (preco >= 1000000) {
        return (preco / 1000000).toFixed(1).replace('.0', '') + 'kk';
      } else if (preco >= 1000) {
        return (preco / 1000).toFixed(1).replace('.0', '') + 'k';
      }
      return preco;
    }

    let todosItens = [];
    let todasCategorias = [];
    let todosUsuarios = [];

    function carregarItens(itens) {
      todosItens = itens;
      renderizarItens(itens);
      atualizarTopVendedores();
    }

    function carregarUsuarios(usuarios) {
      todosUsuarios = usuarios;
      atualizarTopVendedores();
    }

    function atualizarTopVendedores() {
      if (!todosItens.length || !todosUsuarios.length) return;
      // Conta itens por vendedor
      const contagem = {};
      todosItens.forEach(item => {
        contagem[item.vendedor_id] = (contagem[item.vendedor_id] || 0) + 1;
      });
      // Cria array de vendedores com contagem
      const ranking = todosUsuarios
        .map(u => ({
          id: u.id,
          nome: u.nome,
          nick: u.nick,
          perfilImg: u.perfilImg,
          whatsapp: u.whatsapp,
          total: contagem[u.id] || 0
        }))
        .filter(u => u.total > 0)
        .sort((a, b) => b.total - a.total)
        .slice(0, 3);

      const lista = document.getElementById('top-vendedores-list');
      lista.innerHTML = '';
      ranking.forEach((v, idx) => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex align-items-center';
        li.innerHTML = `
          <span class="me-2 fw-bold text-primary">${idx + 1}º</span>
          <img src="${v.perfilImg}" alt="${v.nome}" style="width:32px;height:32px;border-radius:50%;object-fit:cover;margin-right:8px;">
          <span class="me-auto">${v.nome}</span>
          <span class="badge bg-success ms-2">${v.total} itens</span>
          <a href="https://wa.me/${v.whatsapp}" target="_blank" class="ms-2 text-success"><i class="fab fa-whatsapp"></i></a>
        `;
        lista.appendChild(li);
      });
    }

    function renderizarItens(itens) {
      const container = document.getElementById('itens-container');
      container.innerHTML = '';
      itens.forEach(item => {
        const card = document.createElement('div');
        card.className = 'col';
        
        // Template para equipamentos (com refino e encantamentos)
        if (item.tipo === "equipamento") {
          card.innerHTML = `
            <div class="card item-card">
              <span class="status-badge badge ${item.status === 'disponivel' ? 'bg-success' : 'bg-danger'}">
                ${item.status === 'disponivel' ? '✔' : '✖'}
              </span>
              
              <div class="item-img-container">
                <img src="_img/_itens/${item.codigo}.png" class="item-img" alt="${item.nome}">
              </div>
              
              <div class="card-body p-3">
                <div class="item-name">
                  ${item.nome} <span class="item-refino">${item.refinamento}</span>
                </div>
                
                <div class="item-category">${mostrarCategoria(item.categoria_id)}</div>
                
                ${item.encantamentos.length > 0 ? `
                  <div class="section-title">Encantamentos:</div>
                  <div>
                    ${item.encantamentos.map(enc => `
                      <span class="badge badge-encantamento">${enc}</span>
                    `).join('')}
                  </div>
                ` : ''}
                
                ${item.cartas.length > 0 ? `
                  <div class="section-title">Cartas:</div>
                  <div>
                    ${item.cartas.map(carta => `
                      <span class="badge badge-carta">${carta}</span>
                    `).join('')}
                  </div>
                ` : ''}
                
                <div class="price-container">
                  <i class="fas fa-coins coin-icon"></i>
                  <span class="item-price">${formatarPreco(item.preco)}</span>
                  <span class="ms-2 text-success fw-bold">R$ ${item.preco_reais ? item.preco_reais.toFixed(2) : '--'}</span>
                </div>
                
                <a href="https://www.divine-pride.net/database/item/${item.codigo}" 
                   target="_blank"
                   class="divine-pride-link">
                  <i class="fas fa-external-link-alt"></i> Ver no Divine Pride
                </a>
                
                <button class="btn btn-primary btn-negotiate mt-2" 
                  onclick="negociarItem(${item.id})"
                  ${item.status !== 'disponivel' ? 'disabled' : ''}>
                  <i class="fas fa-handshake"></i> Negociar
                </button>
              </div>
            </div>
          `;
        }
        // Template para cartas (sem encantamentos)
        else if (item.tipo === "carta") {
          card.innerHTML = `
            <div class="card item-card">
              <span class="status-badge badge ${item.status === 'disponivel' ? 'bg-success' : 'bg-danger'}">
                ${item.status === 'disponivel' ? '✔' : '✖'}
              </span>
              
              <div class="item-img-container">
                <img src="_img/_itens/${item.codigo}.png" class="item-img" alt="${item.nome}">
              </div>
              
              <div class="card-body p-3">
                <div class="item-name">${item.nome}</div>
                <div class="item-category">${item.categoria}</div>
                
                <div class="price-container">
                  <i class="fas fa-coins coin-icon"></i>
                  <span class="item-price">${formatarPreco(item.preco)}</span>
                  <span class="ms-2 text-success fw-bold">R$ ${item.preco_reais ? item.preco_reais.toFixed(2) : '--'}</span>
                </div>
                
                <a href="https://www.divine-pride.net/database/item/${item.codigo}" 
                   target="_blank"
                   class="divine-pride-link">
                  <i class="fas fa-external-link-alt"></i> Ver no Divine Pride
                </a>
                
                <button class="btn btn-primary btn-negotiate mt-2" 
                  onclick="negociarItem(${item.id})"
                  ${item.status !== 'disponivel' ? 'disabled' : ''}>
                  <i class="fas fa-handshake"></i> Negociar
                </button>
              </div>
            </div>
          `;
        }
        // Template para pets (sem refino/encantamentos)
        else if (item.tipo === "pet") {
          card.innerHTML = `
            <div class="card item-card">
              <span class="status-badge badge ${item.status === 'disponivel' ? 'bg-success' : 'bg-danger'}">
                ${item.status === 'disponivel' ? '✔' : '✖'}
              </span>
              
              <div class="item-img-container">
                <img src="_img/_itens/${item.codigo}.png" class="item-img" alt="${item.nome}">
              </div>
              
              <div class="card-body p-3">
                <div class="item-name">${item.nome}</div>
                <div class="item-category">${item.categoria}</div>
                
                <div class="price-container">
                  <i class="fas fa-coins coin-icon"></i>
                  <span class="item-price">${formatarPreco(item.preco)}</span>
                  <span class="ms-2 text-success fw-bold">R$ ${item.preco_reais ? item.preco_reais.toFixed(2) : '--'}</span>
                </div>
                
                <a href="https://www.divine-pride.net/database/item/${item.codigo}" 
                   target="_blank"
                   class="divine-pride-link">
                  <i class="fas fa-external-link-alt"></i> Ver no Divine Pride
                </a>
                
                <button class="btn btn-primary btn-negotiate mt-2" 
                  onclick="negociarItem(${item.id})"
                  ${item.status !== 'disponivel' ? 'disabled' : ''}>
                  <i class="fas fa-handshake"></i> Negociar
                </button>
              </div>
            </div>
          `;
        }
        
        container.appendChild(card);
      });
    }

    function mostrarCategoria(categoria_id) {
      const cat = todasCategorias.find(c => c.id === categoria_id);
      return cat ? cat.nome : '';
    }

    // Busca dinâmica
    document.getElementById('form-busca').addEventListener('submit', function(e) {
      e.preventDefault();
      const termo = document.getElementById('input-busca').value.trim().toLowerCase();
      if (!termo) {
        renderizarItens(todosItens);
      } else {
        renderizarItens(todosItens.filter(item => item.nome.toLowerCase().includes(termo)));
      }
    });

    // Ícones para cada categoria
    const categoriaIcones = {
      "Armadura": "fa-shield-alt",
      "Arma": "fa-gavel",
      "Carta": "fa-clone",
      "Pet": "fa-paw",
      "Reais": "fa-money-bill-wave"
    };

    // Categorias como abas/tabs
    function carregarCategorias(categorias) {
      todasCategorias = categorias;
      const tabs = document.getElementById('categorias-tabs');
      tabs.innerHTML = '';

      function ativarAba(tab) {
        Array.from(tabs.querySelectorAll('.nav-link')).forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
      }

      // Aba "Todas"
      const liTodas = document.createElement('li');
      liTodas.className = 'nav-item';
      const aTodas = document.createElement('button');
      aTodas.className = 'nav-link d-flex align-items-center fw-bold';
      aTodas.innerHTML = `<i class="fas fa-th-large me-2"></i> Todas`;
      aTodas.onclick = () => {
        renderizarItens(todosItens);
        ativarAba(aTodas);
      };
      liTodas.appendChild(aTodas);
      tabs.appendChild(liTodas);

      // Abas das categorias
      categorias.forEach(cat => {
        const li = document.createElement('li');
        li.className = 'nav-item';
        const a = document.createElement('button');
        a.className = 'nav-link d-flex align-items-center fw-bold';
        const icone = categoriaIcones[cat.nome] || "fa-tag";
        a.innerHTML = `<i class="fas ${icone} me-2"></i> ${cat.nome}`;
        a.onclick = () => {
          renderizarItens(todosItens.filter(item => item.categoria_id === cat.id));
          ativarAba(a);
        };
        li.appendChild(a);
        tabs.appendChild(li);
      });

      // Aba "Reais" no final
      const liReais = document.createElement('li');
      liReais.className = 'nav-item';
      const aReais = document.createElement('button');
      aReais.className = 'nav-link d-flex align-items-center fw-bold';        
      // Ativa "Todas" por padrão
      ativarAba(aTodas);
    }

    // FUNÇÃO PARA CRIAR O CARD DO VENDEDOR
    // function carregarVendedor(usuario) {
    //   const card = document.getElementById('vendedor-card');
    //   if (!usuario) {
    //     card.innerHTML = `<div class="p-3 text-danger">Erro ao carregar vendedor.</div>`;
    //     return;
    //   }
    //   card.innerHTML = `
    //     <img src="${usuario.perfilImg}" class="seller-img card-img-top" alt="Vendedor">
    //     <div class="card-body text-center">
    //       <h5 class="card-title">⚔ ${usuario.nome}</h5>
    //       <p class="text-success mb-2"><strong>${usuario.nick}</strong></p>
    //       <a href="https://wa.me/${usuario.whatsapp}" class="btn btn-success w-100">
    //         <i class="fab fa-whatsapp"></i> WhatsApp
    //       </a>
    //     </div>
    //   `;
    // }

    // FUNÇÃO PARA NEGOCIAR ITEM VIA WHATSAPP
    function negociarItem(itemId) {
      const item = window._itens.find(i => i.id === itemId);
      if (!item) return;
      
      let mensagem = `Olá, gostaria de negociar:\n\n` +
                   `*${item.nome}${item.refinamento ? ' ' + item.refinamento : ''}*\n` +
                   `Categoria: ${item.categoria}\n`;
      
      if (item.encantamentos && item.encantamentos.length > 0) {
        mensagem += `Encantamentos: ${item.encantamentos.join(', ')}\n`;
      }
      
      if (item.cartas && item.cartas.length > 0) {
        mensagem += `Cartas: ${item.cartas.join(', ')}\n`;
      }
      
      mensagem += `Preço: ${formatarPreco(item.preco)}\n\n` +
                 `Ainda está disponível?`;
      
      window.open(`https://wa.me/5585986882710?text=${encodeURIComponent(mensagem)}`, '_blank');
    }

    // CARREGA OS DADOS DO VENDEDOR E ITENS DO ARQUIVO JSON QUANDO A PÁGINA ABRIR
    document.addEventListener('DOMContentLoaded', function() {
      fetch('usuarios.json')
        .then(res => res.ok ? res.json() : null)
        .then(usuarios => {
          carregarUsuarios(usuarios || []);
        });
      fetch('itens.json')
        .then(res => res.ok ? res.json() : [])
        .then(data => {
          window._itens = data;
          carregarItens(data);
        });
      fetch('categorias.json')
        .then(res => res.ok ? res.json() : [])
        .then(categorias => carregarCategorias(categorias));
    });
  </script>
</body>
</html>